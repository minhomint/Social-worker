<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ Overnight JangMinHo Live </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
        }
        .gradient-text {
            background: linear-gradient(to right, #14b8a6, #06b6d4, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .admin-panel {
            display: none;
        }
        .admin-panel.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- ê³ ì • í—¤ë” -->
    <div class="sticky top-0 z-50 glass-effect border-b border-teal-200 shadow-xl">
        <div class="p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="bg-gradient-to-r from-teal-400 to-cyan-400 p-2 rounded-lg shadow-lg">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-base font-bold text-gray-800">ğŸµ Overnight Live</h1>
                        <p class="text-xs text-teal-600">11/8 PM7 â†’ 11/9 AM7</p>
                    </div>
                </div>
                
                <!-- ê´€ë¦¬ì/ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
                <div class="flex gap-2">
                    <button onclick="toggleAdminMode()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-2 px-3 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                        ğŸ” ê´€ë¦¬ì
                    </button>
                    <button onclick="manualRefresh()" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm md:text-base">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ê´€ë¦¬ì íŒ¨ë„ -->
            <div id="adminPanel" class="admin-panel mb-3 p-3 bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 rounded-xl">
                <h3 class="text-sm font-bold text-purple-800 mb-2">ğŸ” ê´€ë¦¬ì ëª¨ë“œ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <button onclick="goToYouTubePlaylist()" class="bg-gradient-to-r from-red-500 to-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                        â–¶ï¸ YouTube ì¬ìƒëª©ë¡ ë°”ë¡œê°€ê¸°
                    </button>
                    <button onclick="downloadExcel()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                        ğŸ“¥ ì‹¤ì‹œê°„ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="downloadFirebaseExcel()" class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                        ğŸ’¾ Firebase ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <label class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm cursor-pointer text-center">
                        ğŸ“¤ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (ê³ ì • ë°ì´í„° ì—…ë°ì´íŠ¸)
                        <input type="file" id="fileUpload" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(event)">
                    </label>
                </div>
                <div class="mt-2 text-xs text-purple-600">
                    â„¹ï¸ ì—‘ì…€ ì—…ë¡œë“œ: "8PM7", "9AM7" ì‹œíŠ¸ê°€ ìˆëŠ” íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- ë·° ëª¨ë“œ ì „í™˜ -->
            <div class="flex gap-2 mb-3">
                <button id="cardViewBtn" onclick="setViewMode('card')" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-gradient-to-r from-teal-400 to-cyan-400 text-white shadow-lg">
                    ì¹´ë“œë·°
                </button>
                <button id="tableViewBtn" onclick="setViewMode('table')" class="flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-white text-gray-600 shadow">
                    í…Œì´ë¸”ë·°
                </button>
            </div>

            <!-- ìƒíƒœ í‘œì‹œ -->
            <div class="grid grid-cols-3 gap-2 mb-3">
                <div class="bg-gradient-to-br from-teal-50 to-cyan-50 border-2 border-teal-300 rounded-lg p-2 text-center shadow">
                    <div class="text-xs text-teal-700 font-semibold">ì—…ë°ì´íŠ¸</div>
                    <div class="text-xs md:text-sm font-black text-teal-600" id="lastUpdate">--:--</div>
                </div>
                <div class="bg-gradient-to-br from-emerald-50 to-green-50 border-2 border-emerald-300 rounded-lg p-2 text-center shadow">
                    <div class="text-xs text-emerald-700 font-semibold">ì˜ìƒ ìˆ˜</div>
                    <div class="text-xs md:text-sm font-black text-emerald-600" id="videoCount">20</div>
                </div>
                <div class="bg-gradient-to-br from-rose-50 to-pink-50 border-2 border-rose-300 rounded-lg p-2 text-center shadow">
                    <div class="text-xs text-rose-700 font-semibold">ì´ ì¦ê°€</div>
                    <div class="text-xs md:text-sm font-black text-rose-600" id="totalChange">21,639</div>
                </div>
            </div>

            <!-- ì—°ê²° ìƒíƒœ -->
            <div class="text-center">
                <span id="connectionStatus" class="text-xs text-gray-500">ì¤€ë¹„ ì™„ë£Œ</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="p-4">
        <!-- PC: ì¢Œìš° 2ë‹¨ / ëª¨ë°”ì¼: ì„¸ë¡œ ìŠ¤íƒ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- ì™¼ìª½: ì¬ìƒëª©ë¡ í”Œë ˆì´ì–´ (ëª¨ë°”ì¼ì—ì„œëŠ” ìœ„) -->
            <div class="lg:sticky lg:top-24 lg:self-start order-1 lg:order-1">
                <div class="glass-effect border-2 border-teal-300 rounded-2xl p-4 shadow-lg">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">ğŸµ ì¬ìƒëª©ë¡</h2>
                    <p class="text-xs text-gray-600 mb-3">Overnight JangMinHo</p>
                    
                    <!-- YouTube í”Œë ˆì´ì–´ -->
                    <div class="relative" style="padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 15px; box-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);">
                        <div id="player" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                    </div>

                    <!-- í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ -->
                    <div class="mt-4 flex gap-2">
                        <button onclick="restartPlayer()" class="flex-1 bg-gradient-to-r from-teal-500 to-cyan-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                            ğŸ”„ í”Œë ˆì´ì–´ ì¬ì‹œì‘
                        </button>
                        <button onclick="toggleMute()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all text-sm">
                            ğŸ”‡ ìŒì†Œê±°
                        </button>
                    </div>
                    
                    <div class="mt-2 text-center">
                        <span id="playerStatus" class="text-xs text-gray-500">í”Œë ˆì´ì–´ ë¡œë”© ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì¡°íšŒìˆ˜ ì¶”ì  (ëª¨ë°”ì¼ì—ì„œëŠ” ì•„ë˜) -->
            <div class="order-2 lg:order-2">
                <div class="glass-effect border-2 border-teal-300 rounded-2xl p-4 shadow-lg mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-2">ğŸ“Š ì¡°íšŒìˆ˜ ì¶”ì </h2>
                    <p class="text-xs text-gray-600">8ì¼ PM7 â†’ 9ì¼ AM7 ë³€í™”ëŸ‰ + ì‹¤ì‹œê°„</p>
                </div>

                <!-- ì¹´ë“œ ë·° -->
                <div id="cardView" class="space-y-3"></div>
                
                <!-- í…Œì´ë¸” ë·° -->
                <div id="tableView" class="hidden"></div>

                <!-- Firebase ì €ì¥ ë²„íŠ¼ -->
                <div class="mt-6">
                    <button onclick="saveToFirebase()" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                        ğŸ’¾ Firebase ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBDOcjC6DNtM-8xQS6PNZqV7yAFq4PMCR8",
            authDomain: "always-88981.firebaseapp.com",
            projectId: "always-88981",
            storageBucket: "always-88981.firebasestorage.app",
            messagingSenderId: "915000956041",
            appId: "1:915000956041:web:490e0668c560aafd0e6258",
            measurementId: "G-WRWS6GGV8L",
            databaseURL: "https://always-88981-default-rtdb.firebaseio.com"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ì „ì—­ ë³€ìˆ˜ë¡œ export
        window.firebaseDB = database;

        // YouTube API ì„¤ì •
        const YOUTUBE_API_KEY = 'AIzaSyBuoonh-2xdqGo8nQfrTEQBeNDfoL-udfU';
        const PLAYLIST_ID = 'PLfuYGpnnSBu24ryeO51pagt62smucmmGv';

        let currentViewMode = 'card';
        let videosData = [];
        let player;
        let isMuted = false;
        let isAdminMode = false;

        // ì´ˆê¸° ê³ ì • ë°ì´í„° (11ì›” 8ì¼ PM7 / 11ì›” 9ì¼ AM7)
        let INITIAL_DATA = {
            '8PM7': {
                'í™€ë¡œëœ ì‚¬ë‘ (ì•ˆë¬´)': 60065,
                'ë‚´ê²Œ ë‚¨ì€ ì‚¬ë‘ì„ ë“œë¦´ê²Œìš”(OM)': 81065,
                'ì¥ë¯¼í˜¸ìœ íŠœë¸Œ ì‹œì‘ EP.00': 31225,
                'ì¥í•˜ë‹¤ ì¥ë¯¼í˜¸ EP.01': 33629,
                'í™€ë¡œëœì‚¬ë‘(OM )': 81037,
                'í™€ë¡œëœ ì‚¬ë‘': 58753,
                'í•œê³„ë ¹': 93128,
                'í•œê³„ë ¹ (OM )': 139011,
                'ë‚´ ë§ˆìŒì— ë¹„ì¹œ ë‚´ ëª¨ìŠµ': 148768,
                'ë‚´ ê³ì— ìˆì–´ì£¼ | ì•„ì™¸ë…¹ìŒì‹¤': 351825,
                'ë‚´ ê³ì— ìˆì–´ì£¼ (OM)': 149258,
                'ë‚´ ê³ì— ìˆì–´ì£¼': 41155,
                'ë‚´ê²Œ ë‚¨ì€ ì‚¬ë‘ì„ ë“œë¦´ê²Œìš”': 120249,
                'ê·¸ì € ì¹œêµ¬': 102779,
                'ê·¸ë‚ ': 78698,
                'ì‚¬ë‘ì˜ í‹°í‚¤íƒ€ì¹´ ìˆ˜íŠ¸ëŒ„ìŠ¤': 803843,
                'ëŒ€ê°€ìˆ˜ì™€ ëŒ€í˜•ê²¬ì˜ ë§Œë‚¨': 24456,
                'ëŒ€ìì—°ì—ì„œ ì¶¤ëŠ” í™€ë¡œëœ ì‚¬ë‘': 34153,
                'ìŠìœ¼ë¦¬ì˜¤': 337477,
                'ë‚´ ì´ë¦„ ì•„ì‹œì£ ': 8896970
            },
            '9AM7': {
                'í™€ë¡œëœ ì‚¬ë‘ (ì•ˆë¬´)': 61359,
                'ë‚´ê²Œ ë‚¨ì€ ì‚¬ë‘ì„ ë“œë¦´ê²Œìš”(OM)': 82475,
                'ì¥ë¯¼í˜¸ìœ íŠœë¸Œ ì‹œì‘ EP.00': 31659,
                'ì¥í•˜ë‹¤ ì¥ë¯¼í˜¸ EP.01': 34381,
                'í™€ë¡œëœì‚¬ë‘(OM )': 82253,
                'í™€ë¡œëœ ì‚¬ë‘': 59218,
                'í•œê³„ë ¹': 93548,
                'í•œê³„ë ¹ (OM )': 140479,
                'ë‚´ ë§ˆìŒì— ë¹„ì¹œ ë‚´ ëª¨ìŠµ': 150022,
                'ë‚´ ê³ì— ìˆì–´ì£¼ | ì•„ì™¸ë…¹ìŒì‹¤': 352192,
                'ë‚´ ê³ì— ìˆì–´ì£¼ (OM)': 150533,
                'ë‚´ ê³ì— ìˆì–´ì£¼': 41450,
                'ë‚´ê²Œ ë‚¨ì€ ì‚¬ë‘ì„ ë“œë¦´ê²Œìš”': 121686,
                'ê·¸ì € ì¹œêµ¬': 103670,
                'ê·¸ë‚ ': 79429,
                'ì‚¬ë‘ì˜ í‹°í‚¤íƒ€ì¹´ ìˆ˜íŠ¸ëŒ„ìŠ¤': 804213,
                'ëŒ€ê°€ìˆ˜ì™€ ëŒ€í˜•ê±´ì˜ ë§Œë‚¨': 25490,
                'ëŒ€ìì—°ì—ì„œ ì¶¤ëŠ” í™€ë¡œëœ ì‚¬ë‘': 36839,
                'ìŠìœ¼ë¦¬ì˜¤': 338705,
                'ë‚´ ì´ë¦„ ì•„ì‹œì£ ': 8898779
            }
        };

        // ì „ì—­ìœ¼ë¡œ export
        window.videosData = videosData;
        window.INITIAL_DATA = INITIAL_DATA;

        // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
        window.toggleAdminMode = function() {
            if (!isAdminMode) {
                const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (password === '@minho0728') {
                    isAdminMode = true;
                    document.getElementById('adminPanel').classList.add('active');
                    updateStatus('âœ“ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”', 'text-purple-600');
                } else if (password !== null) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } else {
                isAdminMode = false;
                document.getElementById('adminPanel').classList.remove('active');
                updateStatus('âœ“ ê´€ë¦¬ì ëª¨ë“œ ë¹„í™œì„±í™”', 'text-gray-600');
            }
        };

        // YouTube ì¬ìƒëª©ë¡ ë°”ë¡œê°€ê¸°
        window.goToYouTubePlaylist = function() {
            window.open(`https://www.youtube.com/playlist?list=${PLAYLIST_ID}`, '_blank');
        };

        // ì‹¤ì‹œê°„ ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        window.downloadExcel = function() {
            if (window.videosData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                return;
            }

            try {
                // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„
                const excelData = window.videosData.map((video, index) => ({
                    'ìˆœìœ„': index + 1,
                    'ì˜ìƒ ì œëª©': video.title,
                    '8ì¼ PM7': video.pm7 !== null ? video.pm7 : '-',
                    '9ì¼ AM7': video.am7 !== null ? video.am7 : '-',
                    'ì¦ê°': video.change !== null ? video.change : '-',
                    'ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜': video.realtime,
                    'ë§¤ì¹­ ì œëª©': video.matchedKey || '-',
                    'Video ID': video.videoId,
                    'ì—…ë°ì´íŠ¸ ì‹œê°„': new Date(video.timestamp).toLocaleString('ko-KR')
                }));

                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 8 },   // ìˆœìœ„
                    { wch: 40 },  // ì˜ìƒ ì œëª©
                    { wch: 12 },  // 8ì¼ PM7
                    { wch: 12 },  // 9ì¼ AM7
                    { wch: 12 },  // ì¦ê°
                    { wch: 15 },  // ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜
                    { wch: 30 },  // ë§¤ì¹­ ì œëª©
                    { wch: 15 },  // Video ID
                    { wch: 20 }   // ì—…ë°ì´íŠ¸ ì‹œê°„
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'ì¡°íšŒìˆ˜ ë°ì´í„°');

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const now = new Date();
                const filename = `Overnight_Live_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                updateStatus('âœ“ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'text-emerald-600');
                setTimeout(() => {
                    updateStatus('âœ“ ì¤€ë¹„ ì™„ë£Œ', 'text-teal-600');
                }, 2000);
            } catch (error) {
                console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // Firebase ë°ì´í„° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        window.downloadFirebaseExcel = async function() {
            try {
                updateStatus('Firebase ë°ì´í„° ë¡œë”© ì¤‘...', 'text-blue-600 pulse');

                const latestRef = ref(window.firebaseDB, 'overnight/latest');
                const snapshot = await get(latestRef);
                
                if (!snapshot.exists()) {
                    alert('Firebaseì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    updateStatus('âŒ Firebase ë°ì´í„° ì—†ìŒ', 'text-red-600');
                    return;
                }

                const data = snapshot.val();
                
                if (!data.videos || data.videos.length === 0) {
                    alert('Firebaseì— ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„
                const excelData = data.videos.map((video, index) => ({
                    'ìˆœìœ„': index + 1,
                    'ì˜ìƒ ì œëª©': video.title,
                    '8ì¼ PM7': video.pm7 !== null ? video.pm7 : '-',
                    '9ì¼ AM7': video.am7 !== null ? video.am7 : '-',
                    'ì¦ê°': video.change !== null ? video.change : '-',
                    'ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜': video.realtime,
                    'ë§¤ì¹­ ì œëª©': video.matchedKey || '-',
                    'Video ID': video.videoId,
                    'ì €ì¥ ì‹œê°„': new Date(data.timestamp).toLocaleString('ko-KR')
                }));

                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 8 },   // ìˆœìœ„
                    { wch: 40 },  // ì˜ìƒ ì œëª©
                    { wch: 12 },  // 8ì¼ PM7
                    { wch: 12 },  // 9ì¼ AM7
                    { wch: 12 },  // ì¦ê°
                    { wch: 15 },  // ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜
                    { wch: 30 },  // ë§¤ì¹­ ì œëª©
                    { wch: 15 },  // Video ID
                    { wch: 20 }   // ì €ì¥ ì‹œê°„
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'Firebase ë°ì´í„°');

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const saveTime = new Date(data.timestamp);
                const filename = `Firebase_Overnight_${saveTime.getFullYear()}${String(saveTime.getMonth()+1).padStart(2,'0')}${String(saveTime.getDate()).padStart(2,'0')}_${String(saveTime.getHours()).padStart(2,'0')}${String(saveTime.getMinutes()).padStart(2,'0')}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                updateStatus('âœ“ Firebase ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'text-emerald-600');
                setTimeout(() => {
                    updateStatus('âœ“ ì¤€ë¹„ ì™„ë£Œ', 'text-teal-600');
                }, 2000);
            } catch (error) {
                console.error('Firebase ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('Firebase ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                updateStatus('âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'text-red-600');
            }
        };

        // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    updateStatus('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘...', 'text-blue-600 pulse');

                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // 8PM7, 9AM7 ì‹œíŠ¸ í™•ì¸
                    if (!workbook.SheetNames.includes('8PM7') || !workbook.SheetNames.includes('9AM7')) {
                        alert('ì—‘ì…€ íŒŒì¼ì— "8PM7"ê³¼ "9AM7" ì‹œíŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                        updateStatus('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨', 'text-red-600');
                        return;
                    }

                    // ì‹œíŠ¸ ë°ì´í„° ì½ê¸°
                    const sheet8PM7 = workbook.Sheets['8PM7'];
                    const sheet9AM7 = workbook.Sheets['9AM7'];

                    const data8PM7 = XLSX.utils.sheet_to_json(sheet8PM7, { header: 1 });
                    const data9AM7 = XLSX.utils.sheet_to_json(sheet9AM7, { header: 1 });

                    // ìƒˆë¡œìš´ ê³ ì • ë°ì´í„° ìƒì„±
                    const new8PM7 = {};
                    const new9AM7 = {};

                    // ì²« í–‰ì€ í—¤ë”ë¡œ ìŠ¤í‚µ
                    for (let i = 1; i < data8PM7.length; i++) {
                        const row = data8PM7[i];
                        if (row[0] && row[1]) {  // ì œëª©ê³¼ ì¡°íšŒìˆ˜ê°€ ìˆìœ¼ë©´
                            new8PM7[row[0]] = parseInt(row[1]) || 0;
                        }
                    }

                    for (let i = 1; i < data9AM7.length; i++) {
                        const row = data9AM7[i];
                        if (row[0] && row[1]) {
                            new9AM7[row[0]] = parseInt(row[1]) || 0;
                        }
                    }

                    // ë°ì´í„° ê°œìˆ˜ í™•ì¸
                    const count8 = Object.keys(new8PM7).length;
                    const count9 = Object.keys(new9AM7).length;

                    if (count8 === 0 || count9 === 0) {
                        alert('ì—‘ì…€ íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜•ì‹: ì²« ì—´=ì œëª©, ë‘˜ì§¸ ì—´=ì¡°íšŒìˆ˜');
                        updateStatus('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨', 'text-red-600');
                        return;
                    }

                    // í™•ì¸ ë©”ì‹œì§€
                    if (confirm(`8PM7: ${count8}ê°œ, 9AM7: ${count9}ê°œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        window.INITIAL_DATA = {
                            '8PM7': new8PM7,
                            '9AM7': new9AM7
                        };

                        updateStatus('âœ“ ê³ ì • ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'text-emerald-600');
                        
                        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                        setTimeout(async () => {
                            await loadPlaylistData();
                        }, 1000);
                    }

                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message);
                    updateStatus('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨', 'text-red-600');
                }
            };

            reader.readAsArrayBuffer(file);
        };

        // YouTube Player ì´ˆê¸°í™”
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'listType': 'playlist',
                    'list': PLAYLIST_ID,
                    'autoplay': 1,
                    'loop': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'playsinline': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        };

        function onPlayerReady(event) {
            updatePlayerStatus('âœ“ í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ', 'text-emerald-600');
            console.log('YouTube Player Ready');
            
            // ìë™ ì¬ìƒ ì‹œë„
            try {
                event.target.playVideo();
                updatePlayerStatus('â–¶ ì¬ìƒ ì¤‘', 'text-blue-600');
            } catch (e) {
                console.error('ìë™ ì¬ìƒ ì˜¤ë¥˜:', e);
                updatePlayerStatus('âš ï¸ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'text-orange-600');
            }
        }

        function onPlayerStateChange(event) {
            const states = {
                '-1': 'ì‹œì‘ë˜ì§€ ì•ŠìŒ',
                '0': 'ì¢…ë£Œ',
                '1': 'ì¬ìƒ ì¤‘',
                '2': 'ì¼ì‹œì •ì§€',
                '3': 'ë²„í¼ë§',
                '5': 'ë™ì˜ìƒ ì‹ í˜¸'
            };
            
            const stateText = states[event.data] || 'ì•Œ ìˆ˜ ì—†ìŒ';
            console.log('Player State:', stateText);
            
            if (event.data === YT.PlayerState.PLAYING) {
                updatePlayerStatus('â–¶ ì¬ìƒ ì¤‘', 'text-blue-600');
            } else if (event.data === YT.PlayerState.PAUSED) {
                updatePlayerStatus('â¸ ì¼ì‹œì •ì§€', 'text-orange-600');
                // ì¼ì‹œì •ì§€ëœ ê²½ìš° ìë™ìœ¼ë¡œ ì¬ê°œ ì‹œë„
                setTimeout(() => {
                    try {
                        player.playVideo();
                        console.log('ìë™ ì¬ê°œ ì‹œë„');
                    } catch (e) {
                        console.error('ìë™ ì¬ê°œ ì‹¤íŒ¨:', e);
                    }
                }, 1000);
            } else if (event.data === YT.PlayerState.ENDED) {
                updatePlayerStatus('ğŸ”„ ë‹¤ìŒ ì˜ìƒ ë¡œë”©', 'text-teal-600');
                // ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì¬ìƒ
                setTimeout(() => {
                    try {
                        player.playVideo();
                        console.log('ì¬ìƒëª©ë¡ ì¬ì‹œì‘');
                    } catch (e) {
                        console.error('ì¬ì‹œì‘ ì‹¤íŒ¨:', e);
                    }
                }, 1000);
            } else if (event.data === YT.PlayerState.BUFFERING) {
                updatePlayerStatus('â³ ë²„í¼ë§ ì¤‘', 'text-gray-600');
            }
        }

        function onPlayerError(event) {
            console.error('Player Error:', event.data);
            updatePlayerStatus('âŒ í”Œë ˆì´ì–´ ì˜¤ë¥˜', 'text-red-600');
        }

        function updatePlayerStatus(message, colorClass) {
            const status = document.getElementById('playerStatus');
            status.textContent = message;
            status.className = `text-xs font-semibold ${colorClass}`;
        }

        // í”Œë ˆì´ì–´ ì¬ì‹œì‘
        window.restartPlayer = function() {
            if (player && player.playVideo) {
                try {
                    player.stopVideo();
                    setTimeout(() => {
                        player.playVideo();
                        updatePlayerStatus('ğŸ”„ ì¬ì‹œì‘ë¨', 'text-emerald-600');
                    }, 500);
                } catch (e) {
                    console.error('ì¬ì‹œì‘ ì˜¤ë¥˜:', e);
                    updatePlayerStatus('âŒ ì¬ì‹œì‘ ì‹¤íŒ¨', 'text-red-600');
                }
            }
        };

        // ìŒì†Œê±° í† ê¸€
        window.toggleMute = function() {
            if (player && player.isMuted) {
                if (isMuted) {
                    player.unMute();
                    isMuted = false;
                    updatePlayerStatus('ğŸ”Š ì†Œë¦¬ ì¼œì§', 'text-blue-600');
                } else {
                    player.mute();
                    isMuted = true;
                    updatePlayerStatus('ğŸ”‡ ìŒì†Œê±°ë¨', 'text-gray-600');
                }
                
                setTimeout(() => {
                    const state = player.getPlayerState();
                    if (state === YT.PlayerState.PLAYING) {
                        updatePlayerStatus('â–¶ ì¬ìƒ ì¤‘', 'text-blue-600');
                    }
                }, 2000);
            }
        };

        // ì¬ìƒ ìƒíƒœ ì£¼ê¸°ì  ì²´í¬ (3ë¶„ë§ˆë‹¤)
        setInterval(() => {
            if (player && player.getPlayerState) {
                const state = player.getPlayerState();
                console.log('ì •ê¸° ì²´í¬ - Player State:', state);
                
                // ì¼ì‹œì •ì§€ ë˜ëŠ” ì¢…ë£Œ ìƒíƒœë©´ ì¬ìƒ ì‹œë„
                if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.ENDED || state === -1) {
                    try {
                        player.playVideo();
                        console.log('ì •ê¸° ì²´í¬ - ì¬ìƒ ì¬ì‹œì‘');
                    } catch (e) {
                        console.error('ì •ê¸° ì²´í¬ - ì¬ìƒ ì‹¤íŒ¨:', e);
                    }
                }
            }
        }, 3 * 60 * 1000); // 3ë¶„

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, color = 'text-teal-600') {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = `text-xs font-semibold ${color}`;
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // ì œëª© ì •ê·œí™” (ë¹„êµìš©)
        function normalizeTitle(title) {
            return title.toLowerCase()
                .replace(/\s+/g, '')
                .replace(/[()|\[\]]/g, '')
                .replace(/official/gi, '')
                .replace(/mv/gi, '')
                .replace(/om/gi, '')
                .replace(/ì¥ë¯¼í˜¸/g, '')
                .replace(/jangminho/gi, '');
        }

        // ì¬ìƒëª©ë¡ ë¹„ë””ì˜¤ ê°€ì ¸ì˜¤ê¸°
        async function fetchPlaylistVideos() {
            updateStatus('ì¬ìƒëª©ë¡ ë¡œë”© ì¤‘...', 'text-blue-600 pulse');
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${PLAYLIST_ID}&key=${YOUTUBE_API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨: ' + response.status);
                }
                
                const data = await response.json();
                return data.items;
            } catch (error) {
                console.error('ì¬ìƒëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
                updateStatus('âŒ ì¬ìƒëª©ë¡ ë¡œë”© ì‹¤íŒ¨', 'text-red-600');
                return [];
            }
        }

        // ë¹„ë””ì˜¤ í†µê³„ ê°€ì ¸ì˜¤ê¸°
        async function fetchVideoStats(videoIds) {
            updateStatus('ì¡°íšŒìˆ˜ ìˆ˜ì§‘ ì¤‘...', 'text-blue-600 pulse');
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoIds.join(',')}&key=${YOUTUBE_API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error('API ìš”ì²­ ì‹¤íŒ¨: ' + response.status);
                }
                
                const data = await response.json();
                return data.items;
            } catch (error) {
                console.error('ì¡°íšŒìˆ˜ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
                updateStatus('âŒ ì¡°íšŒìˆ˜ ìˆ˜ì§‘ ì‹¤íŒ¨', 'text-red-600');
                return [];
            }
        }

        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        async function loadPlaylistData() {
            const playlistItems = await fetchPlaylistVideos();
            
            if (playlistItems.length === 0) {
                return;
            }
            
            const videoIds = playlistItems.map(item => item.snippet.resourceId.videoId);
            const videoStats = await fetchVideoStats(videoIds);
            
            if (videoStats.length > 0) {
                window.videosData = videoStats.map(item => {
                    const videoId = item.id;
                    const title = item.snippet.title;
                    const realtime = parseInt(item.statistics.viewCount);
                    
                    // ê³ ì • ë°ì´í„°ì—ì„œ ë§¤ì¹­ë˜ëŠ” ì œëª© ì°¾ê¸°
                    let pm7 = null;
                    let am7 = null;
                    let matchedKey = null;
                    
                    const normalizedTitle = normalizeTitle(title);
                    
                    for (const [key, value] of Object.entries(window.INITIAL_DATA['8PM7'])) {
                        const normalizedKey = normalizeTitle(key);
                        if (normalizedTitle.includes(normalizedKey) || normalizedKey.includes(normalizedTitle)) {
                            pm7 = value;
                            am7 = window.INITIAL_DATA['9AM7'][key];
                            matchedKey = key;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ nullë¡œ ì„¤ì • (í‘œì— ì—†ëŠ” ì˜ìƒ)
                    const change = (pm7 !== null && am7 !== null) ? am7 - pm7 : null;
                    
                    return {
                        videoId: videoId,
                        title: title,
                        pm7: pm7,           // 8ì¼ PM 7ì‹œ (ê³ ì •) - ì—†ìœ¼ë©´ null
                        am7: am7,           // 9ì¼ AM 7ì‹œ (ê³ ì •) - ì—†ìœ¼ë©´ null
                        realtime: realtime, // ì‹¤ì‹œê°„
                        change: change,     // ì¦ê° (AM7 - PM7) - ì—†ìœ¼ë©´ null
                        matchedKey: matchedKey, // ë§¤ì¹­ëœ í‘œ ë°ì´í„° í‚¤
                        timestamp: new Date().toISOString()
                    };
                });
                
                // ì •ë ¬: ì¦ê°ì´ ìˆëŠ” ì˜ìƒ ìš°ì„ , ê·¸ ë‹¤ìŒ ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜
                window.videosData.sort((a, b) => {
                    if (a.change !== null && b.change === null) return -1;
                    if (a.change === null && b.change !== null) return 1;
                    if (a.change !== null && b.change !== null) return b.change - a.change;
                    return b.realtime - a.realtime;
                });
                
                // ì˜ìƒ ìˆ˜ ì—…ë°ì´íŠ¸
                document.getElementById('videoCount').textContent = window.videosData.length;
                
                // ì´ ì¦ê°€ëŸ‰ ê³„ì‚° (null ì œì™¸)
                const totalChange = window.videosData
                    .filter(v => v.change !== null)
                    .reduce((sum, v) => sum + v.change, 0);
                document.getElementById('totalChange').textContent = totalChange.toLocaleString();
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                const now = new Date();
                document.getElementById('lastUpdate').textContent = formatTime(now);
                
                updateStatus('âœ“ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'text-emerald-600');
                renderView();
            }
        }

        // ë·° ë Œë”ë§
        function renderView() {
            if (currentViewMode === 'card') {
                renderCardView(window.videosData);
            } else {
                renderTableView(window.videosData);
            }
        }

        // ì¹´ë“œ ë·° ë Œë”ë§
        function renderCardView(videos) {
            const cardView = document.getElementById('cardView');
            
            cardView.innerHTML = videos.map((video, index) => {
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                
                // null ì²˜ë¦¬
                const pm7Display = video.pm7 !== null ? video.pm7.toLocaleString() : '-';
                const am7Display = video.am7 !== null ? video.am7.toLocaleString() : '-';
                const changeDisplay = video.change !== null ? 
                    (video.change > 0 ? '+' : '') + video.change.toLocaleString() : '-';
                
                const changeColor = video.change !== null ? 
                    (video.change > 0 ? 'text-emerald-600' : video.change < 0 ? 'text-red-600' : 'text-gray-600') : 
                    'text-gray-400';
                
                const hasTableData = video.change !== null;
                const matchInfo = hasTableData ? 
                    `<div class="text-xs text-teal-600 mt-1">ğŸ“‹ í‘œ ë°ì´í„°: ${video.matchedKey}</div>` :
                    `<div class="text-xs text-orange-600 mt-1">âš ï¸ í‘œ ë°ì´í„° ì—†ìŒ</div>`;
                
                return `
                    <div class="glass-effect border-2 ${hasTableData ? 'border-teal-200' : 'border-gray-200'} rounded-2xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-all ${!hasTableData ? 'opacity-75' : ''}">
                        <div class="flex items-start gap-2 md:gap-3 mb-3">
                            <div class="text-xl md:text-2xl flex-shrink-0">${rankIcon}</div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-gray-800 text-sm md:text-base line-clamp-2">${video.title}</h3>
                                ${matchInfo}
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-lg p-2 md:p-3 border-2 border-purple-200 shadow text-center">
                                <div class="text-xs text-purple-600 mb-1 font-semibold">8ì¼ PM7</div>
                                <div class="text-xs md:text-sm font-bold text-purple-700">${pm7Display}</div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-2 md:p-3 border-2 border-blue-200 shadow text-center">
                                <div class="text-xs text-blue-600 mb-1 font-semibold">9ì¼ AM7</div>
                                <div class="text-xs md:text-sm font-bold text-blue-700">${am7Display}</div>
                            </div>
                            <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-lg p-2 md:p-3 border-2 border-emerald-300 shadow text-center">
                                <div class="text-xs text-emerald-600 mb-1 font-semibold">ì¦ê°</div>
                                <div class="text-xs md:text-sm font-bold ${changeColor}">${changeDisplay}</div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-3 md:p-4 border-2 border-teal-300 shadow">
                            <div class="text-center">
                                <div class="text-xs font-semibold text-gray-600 mb-2">ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜</div>
                                <div class="text-2xl md:text-3xl font-black gradient-text">
                                    ${video.realtime.toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            cardView.classList.remove('hidden');
            document.getElementById('tableView').classList.add('hidden');
        }

        // í…Œì´ë¸” ë·° ë Œë”ë§
        function renderTableView(videos) {
            const tableView = document.getElementById('tableView');
            
            tableView.innerHTML = `
                <div class="glass-effect border-2 border-teal-200 rounded-2xl overflow-hidden shadow-lg">
                    <div class="bg-gradient-to-r from-teal-100 to-cyan-100 border-b-2 border-teal-300 p-3 grid grid-cols-5 gap-2 text-xs font-bold text-gray-700">
                        <div>ì˜ìƒëª…</div>
                        <div class="text-right">8ì¼ PM7</div>
                        <div class="text-right">9ì¼ AM7</div>
                        <div class="text-right text-emerald-700">ì¦ê°</div>
                        <div class="text-right text-teal-700">ì‹¤ì‹œê°„</div>
                    </div>
                    <div>
                        ${videos.map((video, index) => {
                            const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                            
                            // null ì²˜ë¦¬
                            const pm7Display = video.pm7 !== null ? video.pm7.toLocaleString() : '-';
                            const am7Display = video.am7 !== null ? video.am7.toLocaleString() : '-';
                            const changeDisplay = video.change !== null ? 
                                (video.change > 0 ? '+' : '') + video.change.toLocaleString() : '-';
                            
                            const changeColor = video.change !== null ? 
                                (video.change > 0 ? 'text-emerald-700' : video.change < 0 ? 'text-red-700' : 'text-gray-700') : 
                                'text-gray-400';
                            
                            const hasTableData = video.change !== null;
                            
                            return `
                                <div class="p-2 md:p-3 border-b border-teal-100 ${hasTableData ? (index < 3 ? 'bg-teal-50/50' : 'bg-white/50') : 'bg-gray-50/50'} hover:bg-teal-50 transition-all">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-base md:text-lg">${rankIcon}</span>
                                        <span class="text-gray-800 text-xs md:text-sm font-semibold flex-1 line-clamp-1">
                                            ${video.title}
                                        </span>
                                    </div>
                                    ${hasTableData ? 
                                        `<div class="text-xs text-teal-600 mb-1 ml-7">ğŸ“‹ ${video.matchedKey}</div>` :
                                        `<div class="text-xs text-orange-600 mb-1 ml-7">âš ï¸ í‘œ ë°ì´í„° ì—†ìŒ</div>`
                                    }
                                    <div class="grid grid-cols-4 gap-2 text-xs">
                                        <div class="text-right">
                                            <div class="text-purple-600 mb-0.5 font-semibold">8ì¼ PM7</div>
                                            <div class="text-purple-700 font-mono font-bold">${pm7Display}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-blue-600 mb-0.5 font-semibold">9ì¼ AM7</div>
                                            <div class="text-blue-700 font-mono font-bold">${am7Display}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="${changeColor} mb-0.5 font-semibold">ì¦ê°</div>
                                            <div class="${changeColor} font-mono font-black">${changeDisplay}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-teal-600 mb-0.5 font-semibold">ì‹¤ì‹œê°„</div>
                                            <div class="text-teal-700 font-mono font-black">${video.realtime.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            tableView.classList.remove('hidden');
            document.getElementById('cardView').classList.add('hidden');
        }

        // ë·° ëª¨ë“œ ë³€ê²½
        window.setViewMode = function(mode) {
            currentViewMode = mode;
            
            const cardBtn = document.getElementById('cardViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');
            
            if (mode === 'card') {
                cardBtn.className = 'flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-gradient-to-r from-teal-400 to-cyan-400 text-white shadow-lg';
                tableBtn.className = 'flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-white text-gray-600 shadow';
            } else {
                cardBtn.className = 'flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-white text-gray-600 shadow';
                tableBtn.className = 'flex-1 py-2 px-3 rounded-lg font-semibold text-sm transition-all bg-gradient-to-r from-teal-400 to-cyan-400 text-white shadow-lg';
            }
            
            if (window.videosData.length > 0) {
                renderView();
            }
        };

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
        window.manualRefresh = async function() {
            await loadPlaylistData();
        };

        // Firebase ì €ì¥
        window.saveToFirebase = async function() {
            if (window.videosData.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                updateStatus('Firebase ì €ì¥ ì¤‘...', 'text-blue-600 pulse');
                
                const now = new Date();
                
                const dataToSave = {
                    timestamp: now.toISOString(),
                    videos: window.videosData
                };
                
                await set(ref(window.firebaseDB, 'overnight/snapshots/' + Date.now()), dataToSave);
                await set(ref(window.firebaseDB, 'overnight/latest'), dataToSave);
                
                updateStatus('âœ“ Firebase ì €ì¥ ì™„ë£Œ', 'text-emerald-600');
                
                setTimeout(() => {
                    updateStatus('âœ“ ì¤€ë¹„ ì™„ë£Œ', 'text-teal-600');
                }, 2000);
            } catch (error) {
                console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', error);
                alert('Firebase ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                updateStatus('âŒ ì €ì¥ ì‹¤íŒ¨', 'text-red-600');
            }
        };

        // ì´ˆê¸°í™”
        async function initialize() {
            updateStatus('ì´ˆê¸°í™” ì¤‘...', 'text-blue-600');
            await loadPlaylistData();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        initialize();
    </script>
</body>
</html>
